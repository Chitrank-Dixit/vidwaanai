# Makefile-docker - Docker-based workflows for VidwaanAI

.PHONY: help \
	docker-build docker-up docker-down docker-logs docker-shell \
	docker-first-run \
	docker-generate docker-test docker-test-lang docker-test-category \
	docker-analyze docker-report \
	docker-workflow docker-workflow-quick \
	docker-graph-build \
	docker-test-unit docker-test-functional docker-test-integration docker-test-e2e docker-test-all \
	docker-lint docker-format docker-check docker-security docker-lint-all \
	docker-cache-status docker-cache-clear docker-cache-prune docker-clean-all \
	mcp-build mcp-up mcp-down mcp-logs mcp-test mcp-int

# ———- Configuration ———-
# Colors
BOLD := $(shell tput bold)
GREEN := $(shell tput setaf 2)
YELLOW := $(shell tput setaf 3)
CYAN := $(shell tput setaf 6)
RED := $(shell tput setaf 1)
RESET := $(shell tput sgr0)

# Docker Compose files
COMPOSE_FULL := docker-compose -f docker-compose-full.yml
COMPOSE_TEST := docker-compose -p vidwaan-test -f docker-compose-test.yml
COMPOSE_MCP := docker-compose -f docker-compose-mcp.yml

# Default language and category for specific targets
L ?= hi
C ?= bhagavad_gita
NUM_WORKERS ?= 4

# ———- Help ———-
help:
	@echo "$(BOLD)VidwaanAI Docker Commands$(RESET)"
	@echo
	@echo "Usage: $(GREEN)make -f Makefile-docker [target] [VAR=value]$(RESET)"
	@echo
	@echo "$(CYAN)Lifecycle:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker docker-build$(RESET)        Build containers"
	@echo "  $(GREEN)make -f Makefile-docker docker-up$(RESET)           Start services in detached mode"
	@echo "  $(GREEN)make -f Makefile-docker docker-down$(RESET)         Stop services"
	@echo "  $(GREEN)make -f Makefile-docker docker-logs$(RESET)         View logs"
	@echo "  $(GREEN)make -f Makefile-docker docker-shell$(RESET)        Open a shell in the 'app' container"
	@echo
	@echo "$(CYAN)Setup:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker docker-first-run$(RESET)    Initialize DB and load data"
	@echo
	@echo "$(CYAN)Generate & Test:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker docker-generate$(RESET)      Generate prompts"
	@echo "  $(GREEN)make -f Makefile-docker docker-test$(RESET)        Run the full test suite"
	@echo "  $(GREEN)make -f Makefile-docker docker-test-lang L=...$(RESET) Test a specific language"
	@echo "  $(GREEN)make -f Makefile-docker docker-test-category C=...$(RESET) Test a specific category"
	@echo
	@echo "$(CYAN)Analysis & Report:$(RESET)"
docker-test-setup:
	@echo "$(YELLOW)Setting up test data (Reset + Load)...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-integration sh -c "uv run python scripts/reset_data.py && uv run python scripts/load_sample_data.py"

docker-analyze:
	@echo "$(YELLOW)Running full analysis pipeline (Reset -> Load -> Verify -> Evaluate)...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-integration sh scripts/run_analysis_pipeline.sh

docker-report:
	@echo "$(YELLOW)Generating report...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-unit uv run python scripts/generate_report.py

docker-test-quality: docker-analyze
	@echo "$(YELLOW)Running Quality Gate Check...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-integration uv run python scripts/check_metrics.py

docker-workflow: docker-generate docker-test-all docker-analyze docker-report
	@echo "$(GREEN)✓ Full workflow completed!$(RESET)"

docker-workflow-quick: docker-test-unit docker-report
	@echo "$(GREEN)✓ Quick workflow completed!$(RESET)"
	@echo
	@echo "$(CYAN)Knowledge Graph:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker docker-graph-build$(RESET)  Build knowledge graph"
	@echo
	@echo "$(CYAN)Testing:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker docker-test-unit$(RESET)        Run unit tests"
	@echo "  $(GREEN)make -f Makefile-docker docker-test-functional$(RESET)  Run functional tests"
	@echo "  $(GREEN)make -f Makefile-docker docker-test-integration$(RESET) Run integration tests"
	@echo "  $(GREEN)make -f Makefile-docker docker-test-e2e$(RESET)         Run E2E tests"
	@echo "  $(GREEN)make -f Makefile-docker docker-test-all$(RESET)         Run all tests"
	@echo "  $(GREEN)make -f Makefile-docker docker-test-cleanup$(RESET)     Clean up the test environment"
	@echo
	@echo "$(CYAN)Quality Assurance:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker docker-lint$(RESET)         Lint code"
	@echo "  $(GREEN)make -f Makefile-docker docker-format$(RESET)       Format code"
	@echo "  $(GREEN)make -f Makefile-docker docker-check$(RESET)        Type check"
	@echo "  $(GREEN)make -f Makefile-docker docker-security$(RESET)     Security checks"
	@echo "  $(GREEN)make -f Makefile-docker docker-lint-all$(RESET)     Run all QA checks"
	@echo
	@echo "$(CYAN)Caching:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker docker-cache-status$(RESET) Show cache status"
	@echo "  $(GREEN)make -f Makefile-docker docker-cache-clear$(RESET)  Clear caches"
	@echo "  $(GREEN)make -f Makefile-docker docker-cache-prune$(RESET)  Prune Docker volumes"
	@echo "  $(GREEN)make -f Makefile-docker docker-clean-all$(RESET)    Full cleanup"
	@echo
	@echo "$(CYAN)MCP Server:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker mcp-build$(RESET)       Build MCP containers"
	@echo "  $(GREEN)make -f Makefile-docker mcp-up$(RESET)          Start MCP services"
	@echo "  $(GREEN)make -f Makefile-docker mcp-down$(RESET)        Stop MCP services"
	@echo "  $(GREEN)make -f Makefile-docker mcp-logs$(RESET)        View logs"
	@echo "  $(GREEN)make -f Makefile-docker mcp-test$(RESET)        Run MCP unit tests"
	@echo "  $(GREEN)make -f Makefile-docker mcp-int$(RESET)         Run MCP integration tests"
	@echo
	@echo "$(CYAN)VARIABLES:$(RESET)"
	@echo "  $(GREEN)L=$(L)         Language code (e.g., hi, bho)"
	@echo "  $(GREEN)C=$(C)      Category (e.g., ramayana, gita)"
	@echo "  $(GREEN)NUM_WORKERS=$(NUM_WORKERS)  Number of parallel workers"

# ———- Docker Commands ———-

# Lifecycle
docker-build:
	@echo "$(YELLOW)Building all Docker containers...$(RESET)"
	@$(COMPOSE_FULL) build

docker-up:
	@echo "$(YELLOW)Starting all Docker services in detached mode...$(RESET)"
	@$(COMPOSE_FULL) up -d

docker-down:
	@echo "$(YELLOW)Stopping all Docker services...$(RESET)"
	@$(COMPOSE_FULL) down

docker-logs:
	@echo "$(YELLOW)Tailing logs from all services...$(RESET)"
	@$(COMPOSE_FULL) logs -f

docker-shell:
	@echo "$(YELLOW)Opening a shell in the 'app' container...$(RESET)"
	@$(COMPOSE_FULL) exec app /bin/bash

# Setup
docker-first-run: docker-up
	@echo "$(YELLOW)Waiting for database...$(RESET)"
	@sleep 5
	@echo "$(YELLOW)Initializing database...$(RESET)"
	@$(COMPOSE_FULL) exec app uv run python scripts/setup_db.py
	@echo "$(YELLOW)Loading sample data...$(RESET)"
	@$(COMPOSE_FULL) exec app uv run python scripts/load_sample_data.py
	@echo "$(GREEN)✓ Docker first run setup complete!$(RESET)"

# Knowledge Graph
docker-graph-build:
	@echo "$(YELLOW)Building knowledge graph...$(RESET)"
	@$(COMPOSE_FULL) exec app uv run python scripts/build_knowledge_graph.py
	@echo "$(GREEN)✓ Knowledge graph built!$(RESET)"

# Generate & Test
docker-generate:
	@echo "$(YELLOW)Generating prompts inside Docker...$(RESET)"
	@$(COMPOSE_FULL) run --rm --no-deps --entrypoint="" app sh -c "python scripts/generate_prompts.py --all"

docker-test:
	@echo "$(YELLOW)Running tests inside Docker...$(RESET)"
	@$(COMPOSE_FULL) run --rm --no-deps --entrypoint="" app sh -c "uv run pytest tests/"

docker-test-lang:
	@echo "$(YELLOW)Testing language: $(L) in container...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-integration uv run pytest tests/ --language $(L) -v

docker-test-category:
	@echo "$(YELLOW)Testing category: $(C) in container...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-integration uv run pytest tests/ --category $(C) -v

# Testing
docker-test-unit:
	@echo "$(YELLOW)Running unit tests...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-unit

docker-test-functional:
	@echo "$(YELLOW)Running functional tests...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-functional

docker-test-integration:
	@echo "$(YELLOW)Running integration tests...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-integration

docker-test-e2e:
	@echo "$(YELLOW)Running E2E tests...$(RESET)"
	@$(COMPOSE_TEST) run --rm vidwaan-test-e2e

docker-test-cleanup:
	@echo "$(YELLOW)Cleaning up test environment...$(RESET)"
	@$(COMPOSE_TEST) down -v

docker-test-all: docker-test-cleanup docker-test-unit docker-test-functional docker-test-integration docker-test-e2e docker-test-cleanup
	@echo "$(GREEN)All Docker tests passed!$(RESET)"

# Quality Assurance
docker-lint:
	@echo "$(YELLOW)Linting code in container...$(RESET)"
	@$(COMPOSE_FULL) run --rm --no-deps --entrypoint="" app sh -c "uv run ruff check src tests scripts"

docker-format:
	@echo "$(YELLOW)Formatting code in container...$(RESET)"
	@$(COMPOSE_FULL) run --rm --no-deps --entrypoint="" app sh -c "uv run black src tests scripts && uv run ruff check --fix src tests scripts"

docker-check:
	@echo "$(YELLOW)Running type checks in container...$(RESET)"
	@$(COMPOSE_FULL) run --rm --no-deps --entrypoint="" app sh -c "uv run mypy src"

docker-security:
	@echo "$(YELLOW)Running security checks in container...$(RESET)"
	@$(COMPOSE_FULL) run --rm --no-deps --entrypoint="" app sh -c "uv run bandit -r src && uv run safety check"

docker-lint-all: docker-format docker-lint docker-check docker-security

# Caching
docker-cache-status:
	@echo "$(YELLOW)Docker Volume Cache Status:$(RESET)"
	@docker volume ls | grep -E "huggingface-cache|torch-cache|vidwaan-models" || echo "No cache volumes found."
	@echo "\n$(YELLOW)On-disk Cache Status:$(RESET)"
	@du -sh ~/.cache/huggingface/ 2>/dev/null || echo "  HuggingFace cache not found."
	@du -sh ~/.cache/torch/ 2>/dev/null || echo "  Torch cache not found."

docker-cache-clear:
	@echo "$(YELLOW)Clearing on-disk model caches...$(RESET)"
	@rm -rf ~/.cache/huggingface/
	@rm -rf ~/.cache/torch/
	@echo "$(GREEN)✓ Caches cleared.$(RESET)"

docker-cache-prune:
	@echo "$(YELLOW)Pruning Docker model cache volumes...$(RESET)"
	@docker volume rm huggingface-cache torch-cache vidwaan-models || echo "No cache volumes to prune."
	@echo "$(GREEN)✓ Docker volumes pruned.$(RESET)"

docker-clean-all: docker-down
	@echo "$(YELLOW)Cleaning up all Docker resources...$(RESET)"
	@docker-compose -f docker-compose-full.yml down -v --remove-orphans
	@docker-compose -f docker-compose-test.yml down -v --remove-orphans
	@docker-compose -f docker-compose-mcp.yml down -v --remove-orphans
	@echo "$(GREEN)✓ Full Docker cleanup complete.$(RESET)"

# ———- MCP Server Commands ———-
mcp-build:
	@echo "$(YELLOW)Building MCP containers...$(RESET)"
	@$(COMPOSE_MCP) build

mcp-up:
	@echo "$(YELLOW)Starting MCP services...$(RESET)"
	@$(COMPOSE_MCP) up -d

mcp-down:
	@echo "$(YELLOW)Stopping MCP services...$(RESET)"
	@$(COMPOSE_MCP) down

mcp-logs:
	@echo "$(YELLOW)Tailing MCP logs...$(RESET)"
	@$(COMPOSE_MCP) logs -f

mcp-test:
	@echo "$(YELLOW)Running MCP unit tests...$(RESET)"
	@$(COMPOSE_MCP) run --rm mcp-server pytest tests/mcp/unit/

mcp-int:
	@echo "$(YELLOW)Running MCP integration tests...$(RESET)"
	@$(COMPOSE_MCP) run --rm mcp-server pytest tests/mcp/integration/

# ———- Information ———-
show-languages:
	@echo "$(BOLD)Supported Languages:$(RESET)"
	@echo "en, hi, sa, bn, gu, kn, ml, mr, ta, te, bho, mai, raj, bgc, hne, doi, kok"

show-categories:
	@echo "$(BOLD)Test Categories:$(RESET)"
	@echo "ramayana, bhagavad_gita, mahabharata, hinduism_bharat"

show-config:
	@echo "$(BOLD)Current Configuration:$(RESET)"
	@echo "  - Language: $(L)"
	@echo "  - Category: $(C)"
	@echo "  - Workers: $(NUM_WORKERS)"