# VidwaanAI Docker Makefile
# Fully containerized workflow

.PHONY: help build up down logs shell first-run query test graph-build

# Colors
BOLD := \033[1m
GREEN := \033[32m
YELLOW := \033[33m
CYAN := \033[36m
RED := \033[31m
RESET := \033[0m

# Docker Compose command
COMPOSE := docker compose -f docker-compose-full.yml

help:
	@echo "$(BOLD)VidwaanAI Docker Commands$(RESET)"
	@echo
	@echo "$(CYAN)Lifecycle:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker build$(RESET)      Build containers"
	@echo "  $(GREEN)make -f Makefile-docker up$(RESET)         Start services (detached)"
	@echo "  $(GREEN)make -f Makefile-docker down$(RESET)       Stop services"
	@echo "  $(GREEN)make -f Makefile-docker logs$(RESET)       View logs"
	@echo
	@echo "$(CYAN)Setup:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker first-run$(RESET)  Initialize DB and load data"
	@echo
	@echo "$(CYAN)Usage:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker query Q=\"...\"$(RESET) Run a query"
	@echo "  $(GREEN)make -f Makefile-docker shell$(RESET)      Open shell in app container"
	@echo "  $(GREEN)make -f Makefile-docker test$(RESET)       Run tests inside container"
	@echo
	@echo "$(CYAN)Graph RAG:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker graph-build$(RESET) Populate knowledge graph"
	@echo
	@echo "$(CYAN)MCP Server:$(RESET)"
	@echo "  $(GREEN)make -f Makefile-docker mcp-build$(RESET)  Build MCP containers"
	@echo "  $(GREEN)make -f Makefile-docker mcp-up$(RESET)     Start MCP server"
	@echo "  $(GREEN)make -f Makefile-docker mcp-down$(RESET)   Stop MCP server"
	@echo "  $(GREEN)make -f Makefile-docker mcp-test$(RESET)   Run MCP unit tests"
	@echo "  $(GREEN)make -f Makefile-docker mcp-int$(RESET)    Run MCP integration tests"

build:
	@echo "$(YELLOW)Building containers...$(RESET)"
	@$(COMPOSE) build

up:
	@echo "$(YELLOW)Starting services...$(RESET)"
	@$(COMPOSE) up -d

down:
	@echo "$(YELLOW)Stopping services...$(RESET)"
	@$(COMPOSE) down

logs:
	@$(COMPOSE) logs -f

shell:
	@echo "$(YELLOW)Opening shell...$(RESET)"
	@$(COMPOSE) exec app /bin/bash

first-run: up
	@echo "$(YELLOW)Waiting for database...$(RESET)"
	@sleep 5
	@echo "$(YELLOW)Initializing database...$(RESET)"
	@$(COMPOSE) exec app uv run python scripts/setup_db.py
	@echo "$(YELLOW)Loading sample data...$(RESET)"
	@$(COMPOSE) exec app uv run python scripts/load_sample_data.py
	@echo "$(GREEN)✓ Setup complete!$(RESET)"

query:
	@if [ -z "$(Q)" ]; then \
		echo "$(RED)Error: Please provide a question using Q=\"...\"$(RESET)"; \
	else \
		$(COMPOSE) exec app uv run python -m src.main query "$(Q)" --verbose; \
	fi

test: test-unit

test-unit:
	@echo "$(YELLOW)Running unit tests...$(RESET)"
	@docker compose -p vidwaan-test -f docker-compose-test.yml run --rm vidwaan-test-unit

test-functional:
	@echo "$(YELLOW)Running functional tests...$(RESET)"
	@docker compose -p vidwaan-test -f docker-compose-test.yml run --rm vidwaan-test-functional

test-integration:
	@echo "$(YELLOW)Running integration tests...$(RESET)"
	@docker compose -p vidwaan-test -f docker-compose-test.yml run --rm vidwaan-test-integration

test-e2e:
	@echo "$(YELLOW)Running E2E tests...$(RESET)"
	@docker compose -p vidwaan-test -f docker-compose-test.yml run --rm vidwaan-test-e2e

test-cleanup:
	@echo "$(YELLOW)Cleaning up test environment...$(RESET)"
	@docker compose -p vidwaan-test -f docker-compose-test.yml down -v

test-all: test-cleanup test-unit test-functional test-integration test-e2e test-cleanup
	@echo "$(GREEN)All tests passed!$(RESET)"

graph-build:
	@echo "$(YELLOW)Building knowledge graph...$(RESET)"
	@$(COMPOSE) exec app uv run python scripts/build_knowledge_graph.py
	@echo "$(GREEN)✓ Knowledge graph built!$(RESET)"

# Cache Management
cache-status:
	@echo "HuggingFace Cache:"
	@du -sh ~/.cache/huggingface/ 2>/dev/null || echo "  Not yet created"
	@echo "Torch Cache:"
	@du -sh ~/.cache/torch/ 2>/dev/null || echo "  Not yet created"
	@echo "Custom Models:"
	@du -sh ./models/ 2>/dev/null || echo "  Not yet created"

cache-clear:
	@echo "Clearing model caches..."
	rm -rf ~/.cache/huggingface/
	rm -rf ~/.cache/torch/
	rm -rf ./models/
	@echo "Caches cleared"

cache-prune:
	docker volume rm huggingface-cache torch-cache vidwaan-models
	@echo "Docker model volumes pruned"

cache-info:
	@echo "Docker Volumes:"
	docker volume ls | grep cache || echo "No cache volumes found"
	@echo ""
	@echo "Volume Details:"
	docker volume inspect huggingface-cache 2>/dev/null || echo "huggingface-cache not found"
	docker volume inspect torch-cache 2>/dev/null || echo "torch-cache not found"

clean-all: down cache-clear cache-prune
	@echo "All cleanup complete"

# MCP Server Commands
MCP_COMPOSE := docker compose -f docker-compose-mcp.yml

mcp-build:
	@echo "$(YELLOW)Building MCP containers...$(RESET)"
	@$(MCP_COMPOSE) build

mcp-up:
	@echo "$(YELLOW)Starting MCP services...$(RESET)"
	@$(MCP_COMPOSE) up -d

mcp-down:
	@echo "$(YELLOW)Stopping MCP services...$(RESET)"
	@$(MCP_COMPOSE) down

mcp-logs:
	@$(MCP_COMPOSE) logs -f

mcp-test:
	@echo "$(YELLOW)Running MCP unit tests...$(RESET)"
	@$(MCP_COMPOSE) run --rm mcp-server pytest tests/mcp/unit/ -v

mcp-int:
	@echo "$(YELLOW)Running MCP integration tests...$(RESET)"
	@$(MCP_COMPOSE) run --rm mcp-server pytest tests/mcp/integration/ -v

