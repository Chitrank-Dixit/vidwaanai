name: CI - VidwaanAI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  VIDWAAN_IMAGE: vidwaan-ci
  MCP_IMAGE: vidwaan-mcp-ci

jobs:
  # ============================================================================
  # UNIT TESTS (Docker-based)
  # ============================================================================

  unit-tests:
    name: Unit Tests - VidwaanAI
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: vidwaan_user
          POSTGRES_PASSWORD: vidwaan_password
          POSTGRES_DB: vidwaan_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Build test image
        run: |
          docker build \
            -f Dockerfile.ci \
            -t ${{ env.VIDWAAN_IMAGE }}:test-${{ github.sha }} \
            --target test \
            .

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://vidwaan_user:vidwaan_password@postgres:5432/vidwaan_test
          REDIS_URL: redis://redis:6379
        run: |
          docker run --rm \
            --network host \
            -e DATABASE_URL=${{ env.DATABASE_URL }} \
            -e REDIS_URL=${{ env.REDIS_URL }} \
            -e CI=true \
            -v ${{ github.workspace }}:/workspace \
            ${{ env.VIDWAAN_IMAGE }}:test-${{ github.sha }} \
            pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=term

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage
          path: coverage.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/

  # ============================================================================
  # FUNCTIONAL TESTS (Docker-based)
  # ============================================================================

  functional-tests:
    name: Functional Tests - VidwaanAI
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: vidwaan_user
          POSTGRES_PASSWORD: vidwaan_password
          POSTGRES_DB: vidwaan_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Build test image
        run: |
          docker build \
            -f Dockerfile.ci \
            -t ${{ env.VIDWAAN_IMAGE }}:test-${{ github.sha }} \
            --target test \
            .

      - name: Run functional tests
        env:
          DATABASE_URL: postgresql://vidwaan_user:vidwaan_password@postgres:5432/vidwaan_test
          REDIS_URL: redis://redis:6379
        run: |
          docker run --rm \
            --network host \
            -e DATABASE_URL=${{ env.DATABASE_URL }} \
            -e REDIS_URL=${{ env.REDIS_URL }} \
            -e CI=true \
            -v ${{ github.workspace }}:/workspace \
            ${{ env.VIDWAAN_IMAGE }}:test-${{ github.sha }} \
            pytest tests/functional/ -v --cov=src --cov-report=xml

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: functional-coverage
          path: coverage.xml

  # ============================================================================
  # INTEGRATION TESTS (Docker-based with Compose)
  # ============================================================================

  integration-tests:
    name: Integration Tests - VidwaanAI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: |
          docker-compose --version

      - name: Build application image
        run: |
          docker build \
            -f Dockerfile \
            -t ${{ env.VIDWAAN_IMAGE }}:integration-${{ github.sha }} \
            .

      - name: Start services with Docker Compose
        run: |
          docker-compose -f docker-compose-test.yml up -d
          sleep 30

      - name: Wait for services to be healthy
        run: |
          docker-compose -f docker-compose-test.yml exec -T app \
            bash -c 'for i in {1..30}; do curl -f http://localhost:8000/health && exit 0; sleep 1; done; exit 1'

      - name: Run integration tests
        run: |
          docker-compose -f docker-compose-test.yml exec -T app \
            pytest tests/integration/ -v --cov=src --cov-report=xml

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage
          path: coverage.xml

      - name: Collect logs on failure
        if: failure()
        run: |
          mkdir -p logs
          docker-compose -f docker-compose-test.yml logs > logs/docker-compose.log
          docker-compose -f docker-compose-test.yml logs app > logs/app.log
          docker-compose -f docker-compose-test.yml logs db > logs/db.log

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-logs
          path: logs/

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f docker-compose-test.yml down -v

  # ============================================================================
  # E2E TESTS (Docker-based)
  # ============================================================================

  e2e-tests:
    name: E2E Tests - VidwaanAI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build application image
        run: |
          docker build \
            -f Dockerfile \
            -t ${{ env.VIDWAAN_IMAGE }}:e2e-${{ github.sha }} \
            .

      - name: Start services with Docker Compose
        run: |
          docker-compose -f docker-compose-test.yml up -d
          sleep 30

      - name: Wait for services to be healthy
        run: |
          docker-compose -f docker-compose-test.yml exec -T app \
            bash -c 'for i in {1..30}; do curl -f http://localhost:8000/health && exit 0; sleep 1; done; exit 1'

      - name: Run E2E tests
        run: |
          docker-compose -f docker-compose-test.yml exec -T app \
            pytest tests/e2e/ -v --timeout=300

      - name: Run performance tests
        run: |
          docker-compose -f docker-compose-test.yml exec -T app \
            pytest tests/performance/ -v --benchmark-only

      - name: Collect metrics
        if: always()
        run: |
          mkdir -p metrics
          docker stats --no-stream > metrics/docker-stats.txt
          docker-compose -f docker-compose-test.yml ps > metrics/services-status.txt

      - name: Upload metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-metrics
          path: metrics/

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f docker-compose-test.yml down -v

  # ============================================================================
  # MCP UNIT TESTS (Docker-based)
  # ============================================================================

  mcp-unit-tests:
    name: Unit Tests - MCP Server
    runs-on: ubuntu-latest
    services:
      postgres-mcp:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: vidwaan_user
          POSTGRES_PASSWORD: vidwaan_password
          POSTGRES_DB: vidwaan_mcp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5434:5432

      redis-mcp:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6380:6379

    steps:
      - uses: actions/checkout@v4

      - name: Build MCP test image
        run: |
          docker build \
            -f Dockerfile.mcp \
            -t ${{ env.MCP_IMAGE }}:test-${{ github.sha }} \
            --target test \
            .

      - name: Run MCP unit tests
        env:
          DATABASE_URL: postgresql://vidwaan_user:vidwaan_password@postgres-mcp:5432/vidwaan_mcp_test
          REDIS_URL: redis://redis-mcp:6379
        run: |
          docker run --rm \
            --network host \
            -e DATABASE_URL=${{ env.DATABASE_URL }} \
            -e REDIS_URL=${{ env.REDIS_URL }} \
            -e CI=true \
            -v ${{ github.workspace }}:/workspace \
            ${{ env.MCP_IMAGE }}:test-${{ github.sha }} \
            pytest tests/mcp/unit/ -v --cov=src/mcp --cov-report=xml

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-unit-coverage
          path: coverage.xml

  # ============================================================================
  # MCP INTEGRATION TESTS (Docker-based)
  # ============================================================================

  mcp-integration-tests:
    name: Integration Tests - MCP Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build MCP image
        run: |
          docker build \
            -f Dockerfile.mcp \
            -t ${{ env.MCP_IMAGE }}:integration-${{ github.sha }} \
            .

      - name: Start MCP services with Docker Compose
        run: |
          docker-compose -f docker-compose-mcp.yml up -d
          sleep 30

      - name: Wait for MCP server to be healthy
        run: |
          for i in {1..30}; do \
            curl -f http://localhost:3000/health && exit 0; \
            sleep 1; \
          done; \
          exit 1

      - name: Run MCP integration tests
        run: |
          docker run --rm \
            --network host \
            -e MCP_SERVER_URL=http://localhost:3000 \
            -e CI=true \
            -v ${{ github.workspace }}:/workspace \
            ${{ env.MCP_IMAGE }}:integration-${{ github.sha }} \
            pytest tests/mcp/integration/ -v --cov=src/mcp --cov-report=xml

      - name: Test MCP tools
        run: |
          docker run --rm \
            --network host \
            -e MCP_SERVER_URL=http://localhost:3000 \
            -v ${{ github.workspace }}:/workspace \
            python:3.11 \
            bash -c 'pip install requests && python tests/mcp/tools_test.py'

      - name: Collect logs on failure
        if: failure()
        run: |
          mkdir -p logs
          docker-compose -f docker-compose-mcp.yml logs > logs/mcp-docker-compose.log

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-integration-logs
          path: logs/

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f docker-compose-mcp.yml down -v

  # ============================================================================
  # COVERAGE REPORT & SUMMARY
  # ============================================================================

  coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    needs:
      - unit-tests
      - functional-tests
      - integration-tests
      - mcp-unit-tests
      - mcp-integration-tests
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports/

      - name: Combine coverage reports
        run: |
          pip install coverage
          cd coverage-reports
          coverage combine */coverage.xml
          coverage report
          coverage html

      - name: Upload combined coverage
        uses: actions/upload-artifact@v4
        with:
          name: combined-coverage-report
          path: htmlcov/

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('coverage-reports/combined-coverage.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Coverage Report\n\`\`\`\n${coverage}\n\`\`\``
            });

  # ============================================================================
  # BUILD IMAGES FOR REGISTRY (Only on main branch)
  # ============================================================================

  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs:
      - unit-tests
      - functional-tests
      - integration-tests
      - e2e-tests
      - mcp-unit-tests
      - mcp-integration-tests
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push VidwaanAI image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}:latest
            ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}

      - name: Build and push MCP image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.mcp
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}-mcp:latest
            ${{ env.REGISTRY }}/${{ github.repository }}-mcp:${{ github.sha }}

  # ============================================================================
  # STATUS CHECK
  # ============================================================================

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    if: always()
    needs:
      - unit-tests
      - functional-tests
      - integration-tests
      - e2e-tests
      - mcp-unit-tests
      - mcp-integration-tests
      - coverage-report
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.unit-tests.result }}" = "failure" ] || \
             [ "${{ needs.functional-tests.result }}" = "failure" ] || \
             [ "${{ needs.integration-tests.result }}" = "failure" ] || \
             [ "${{ needs.e2e-tests.result }}" = "failure" ] || \
             [ "${{ needs.mcp-unit-tests.result }}" = "failure" ] || \
             [ "${{ needs.mcp-integration-tests.result }}" = "failure" ]; then
            echo "CI Pipeline Failed"
            exit 1
          fi
          echo "All CI checks passed!"

      - name: Create success badge
        if: success()
        run: echo "CI Status: PASSED" > ci-status.txt

      - name: Upload CI status
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-status
          path: ci-status.txt
