---
- name: Ensure Output Logs Directory Exists
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../../output/logs"
    state: directory
    mode: '0755'
  tags:
    - ingestion
    - ingest_files

# ——— VEDAS ———
- name: Ingest Rigveda
  ansible.builtin.shell: |
    uv run python -u scripts/ingest_vedas.py \
      --pdf "data/vedas/Rigved.pdf" \
      --ved "Rig Ved" \
      --code "rig" {{ "--force" if force_ingestion | default(false) else "" }} 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/ingestion_vedas.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  register: rigveda_output
  changed_when: true
  ignore_errors: true
  tags:
    - ingestion
    - ingest_files

- name: Ingest Yajurveda
  ansible.builtin.shell: |
    uv run python -u scripts/ingest_vedas.py \
      --pdf "data/vedas/Yajurved.pdf" \
      --ved "Yajur Ved" \
      --code "yajur" {{ "--force" if force_ingestion | default(false) else "" }} 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/ingestion_vedas.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  register: yajurveda_output
  changed_when: true
  ignore_errors: true
  tags:
    - ingestion
    - ingest_files

- name: Ingest Samaveda
  ansible.builtin.shell: |
    uv run python -u scripts/ingest_vedas.py \
      --pdf "data/vedas/Samved.pdf" \
      --ved "Sama Ved" \
      --code "sam" {{ "--force" if force_ingestion | default(false) else "" }} 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/ingestion_vedas.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  register: samaveda_output
  changed_when: true
  ignore_errors: true
  tags:
    - ingestion
    - ingest_files

- name: Ingest Atharvaveda
  ansible.builtin.shell: |
    uv run python -u scripts/ingest_vedas.py \
      --pdf "data/vedas/Atharva-ved.pdf" \
      --ved "Atharva Ved" \
      --code "atharv" {{ "--force" if force_ingestion | default(false) else "" }} 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/ingestion_vedas.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  register: atharvaveda_output
  changed_when: true
  ignore_errors: true
  tags:
    - ingestion
    - ingest_files

- name: Ingest Bhagavad Gita
  ansible.builtin.shell: |
    uv run python -u scripts/ingest_scripture.py \
      --pdf "data/bhagwat_geeta/bhagwat_geeta.pdf" \
      --name "Bhagavad Gita" \
      --code "gita" \
      --type "gita" {{ "--force" if force_ingestion | default(false) else "" }} 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/ingestion_scriptures.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  register: gita_output
  changed_when: true
  ignore_errors: true
  tags:
    - ingestion
    - ingest_files

- name: Ingest Ramayana
  ansible.builtin.shell: |
    # Ingesting Ramayana
    uv run python -u scripts/ingest_scripture.py \
      --pdf "data/ramayan/ramayana.pdf" \
      --name "Ramayana" \
      --code "ram" \
      --type "ramayana" {{ "--force" if force_ingestion | default(false) else "" }} 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/ingestion_scriptures.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  register: ramayana_output
  changed_when: true
  ignore_errors: true
  tags:
    - ingestion
    - ingest_files

- name: Ingest Mahabharat
  ansible.builtin.shell: |
    # Ingesting Mahabharat
    uv run python -u scripts/ingest_scripture.py \
      --pdf "data/mahabharat/mahabhart.pdf" \
      --name "Mahabharat" \
      --code "mb" \
      --type "mahabharat" {{ "--force" if force_ingestion | default(false) else "" }} 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/ingestion_scriptures.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  register: mahabharat_output
  changed_when: true
  ignore_errors: true
  tags:
    - ingestion
    - ingest_files

- name: Find Purana PDFs
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/../../data/puranas"
    patterns: "*.pdf"
  register: purana_files
  tags:
    - ingestion
    - ingest_files

- name: Ingest Puranas
  ansible.builtin.shell: |
    filename=$(basename "{{ item.path }}")
    filename_no_ext="${filename%.*}"
    # Basic title case and clean up
    readable_name=$(echo "$filename_no_ext" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++)sub(/./,toupper(substr($i,1,1)),$i)}1')
    code=$(echo "$filename_no_ext" | tr '-' '_' | tr '[:upper:]' '[:lower:]')
    
    echo "Processing Purana: $readable_name"
    uv run python -u scripts/ingest_scripture.py \
      --pdf "{{ item.path }}" \
      --name "$readable_name" \
      --code "$code" \
      --type "purana" {{ "--force" if force_ingestion | default(false) else "" }} 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/ingestion_scriptures.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  loop: "{{ purana_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  register: purana_output
  changed_when: true
  ignore_errors: true
  tags:
    - ingestion
    - ingest_files

# ——— POST-PROCESSING ———
- name: Run Vectorization
  ansible.builtin.shell: |
    uv run python -u scripts/vectorize_vedas_and_scriptures.py 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/vectorization.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  register: vectorization_output
  changed_when: true
  tags:
    - ingestion
    - vectorize

- name: Build Knowledge Graph
  ansible.builtin.shell: |
    uv run python -u scripts/build_knowledge_graph.py 2>&1 | tee -a "{{ playbook_dir }}/../../output/logs/kg_build.log"
  args:
    chdir: "{{ playbook_dir }}/../.."
  register: kg_build_output
  changed_when: true
  tags:
    - ingestion
    - build_graph

- name: Log Ingestion Summary
  ansible.builtin.debug:
    msg: 
      - "Full logging available in output/logs/"
      - "Vedas Processed: {{ rigveda_output.rc is defined and rigveda_output.rc == 0 }}, {{ yajurveda_output.rc is defined and yajurveda_output.rc == 0 }}, ..."
      - "Puranas Found: {{ purana_files.matched | default('0') }}"
  tags:
    - ingestion
    - ingest_files
