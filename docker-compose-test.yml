

services:
  # Base test service with common configuration
  test-base:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./scripts:/app/scripts
      - ./pyproject.toml:/app/pyproject.toml
      - ./uv.lock:/app/uv.lock
    environment:
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql://vidwaan_user:vidwaan_password@postgres-test:5432/vidwaan_test
      - NEO4J_URI=bolt://neo4j-test:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=vidwaan123_test
      - OPENAI_API_KEY=test_key
      - LMSTUDIO_BASE_URL=http://host.docker.internal:1234/v1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: []

  # Unit Tests - No external dependencies
  vidwaan-test-unit:
    extends: test-base
    command: uv run pytest tests/unit -v
    profiles: ["unit"]

  # Functional Tests - Requires PostgreSQL
  vidwaan-test-functional:
    extends: test-base
    depends_on:
      postgres-test:
        condition: service_healthy
    command: uv run pytest tests/functional -v
    profiles: ["functional"]

  # Integration Tests - Requires PostgreSQL and Neo4j
  vidwaan-test-integration:
    extends: test-base
    depends_on:
      postgres-test:
        condition: service_healthy
      neo4j-test:
        condition: service_started
    command: uv run pytest tests/integration -v
    profiles: ["integration"]

  # E2E Tests - Full stack
  vidwaan-test-e2e:
    extends: test-base
    depends_on:
      postgres-test:
        condition: service_healthy
      neo4j-test:
        condition: service_started
    command: uv run pytest tests/e2e -v
    profiles: ["e2e"]

  # Test Database
  postgres-test:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: vidwaan_user
      POSTGRES_PASSWORD: vidwaan_password
      POSTGRES_DB: vidwaan_test
    ports:
      - "5433:5432" # Avoid conflict with dev db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vidwaan_user -d vidwaan_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    tmpfs:
      - /var/lib/postgresql/data
    volumes:
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql

  # Test Graph Database
  neo4j-test:
    image: neo4j:5.15-community
    environment:
      NEO4J_AUTH: neo4j/vidwaan123_test
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
    ports:
      - "7688:7687" # Avoid conflict with dev db
      - "7475:7474"
    tmpfs:
      - /data
      - /logs
